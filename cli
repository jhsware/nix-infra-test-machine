#!/usr/bin/env bash
set -a
SCRIPT_DIR=$(dirname "$0")
WORK_DIR=${WORK_DIR:-"$(readlink -f "$SCRIPT_DIR/..")"}
NIX_INFRA=${NIX_INFRA:-"nix-infra"}
NIXOS_VERSION=${NIXOS_VERSION:-"25.11"}
SSH_KEY=${SSH_KEY:-"nixinfra-machine"}
SSH_EMAIL=${SSH_EMAIL:-"your-email@example.com"}
SECRETS_PWD=${SECRETS_PWD:-"my_secrets_password"}
LOCATION=${LOCATION:-"hel1"}
MACHINE_TYPE=${MACHINE_TYPE:-"cpx21"}
set +a

# Check for nix-infra CLI
if ! command -v nix-infra >/dev/null 2>&1; then
  echo "The 'nix-infra' cli is required for this script to work."
  echo "Visit https://github.com/jhsware/nix-infra for instructions on installation"
  exit 1
fi

__help_text__=$(cat <<EOF
nix-infra-machine CLI
=====================

Usage: $0 <command> [options]

Commands:
  create <nodes>      Provision and initialize machines
  update <nodes>      Update node configuration and deploy apps
  upgrade <nodes>     Upgrade NixOS version on nodes
  rollback <nodes>    Rollback to previous NixOS configuration
  destroy             Destroy machines (requires --target)

  ssh <node>          SSH into a node
  cmd --target=<nodes> <command>   Run command on node(s)
  action --target=<node> <module> <cmd>   Run app action
  port-forward --target=<node> --port-mapping=<local:remote>

Options:
  --env=<file>        Environment file (default: .env)
  --target=<nodes>    Target node(s) for commands

Examples:
  # Create a new machine
  $0 create --env=.env node001

  # Create multiple machines
  $0 create --env=.env node001 node002 node003

  # SSH into a machine
  $0 ssh --env=.env node001

  # Run a command on a machine
  $0 cmd --env=.env --target=node001 "systemctl status nginx"

  # Update configuration
  $0 update --env=.env node001

  # Destroy machines
  $0 destroy --env=.env --target="node001 node002"
EOF
)

if [[ "create upgrade rollback destroy update ssh cmd action port-forward" == *"$1"* ]]; then
  CMD="$1"
  shift
else
  echo "$__help_text__"
  exit 1
fi

for i in "$@"; do
  case $i in
    --help)
    echo "$__help_text__"
    exit 0
    ;;
    --env=*)
    ENV="${i#*=}"
    shift
    ;;
    --target=*)
    TARGET="${i#*=}"
    shift
    ;;
    --port-mapping=*)
    PORT_MAPPING="${i#*=}"
    shift
    ;;
    *)
    REST="$@"
    ;;
  esac
done

# Read the environment file if provided
if [ "$ENV" != "" ] && [ -f "$ENV" ]; then
  set -a
  source "$ENV"
  set +a
fi

# A Hetzner Cloud token is required
if [ -z "$HCLOUD_TOKEN" ]; then
  echo "Missing env-var HCLOUD_TOKEN. Load through .env-file that is specified through --env."
  exit 1
fi

# ============================================================================
# Helper Functions
# ============================================================================

printTime() {
  local _start=$1; local _end=$2; local _secs=$((_end-_start))
  printf '%02dh:%02dm:%02ds' $((_secs/3600)) $((_secs%3600/60)) $((_secs%60))
}

destroyNodes() {
  $NIX_INFRA fleet destroy -d "$WORK_DIR" --batch \
      --target="$TARGET"
}

cleanupOnFail() {
  if [ $1 -ne 0 ]; then
    echo "$2"
    destroyNodes
    exit 1
  fi
}

# ============================================================================
# Interactive Commands
# ============================================================================

if [ "$CMD" = "ssh" ]; then
  if [ -z "$REST" ]; then
    echo "Usage: $0 ssh --env=.env <node>"
    exit 1
  fi
  $NIX_INFRA fleet ssh -d "$WORK_DIR" --target="$REST"
  exit 0
fi

if [ "$CMD" = "cmd" ]; then
  if [ -z "$TARGET" ] || [ -z "$REST" ]; then
    echo "Usage: $0 cmd --env=.env --target=<node> <command>"
    exit 1
  fi
  $NIX_INFRA fleet cmd -d "$WORK_DIR" --target="$TARGET" "$REST"
  exit 0
fi

if [ "$CMD" = "action" ]; then
  if [ -z "$TARGET" ] || [ -z "$REST" ]; then
    echo "Usage: $0 action --env=.env --target=<node> <module> <cmd>"
    exit 1
  fi
  
  read -r module action_cmd <<< "$REST"
  $NIX_INFRA fleet action -d "$WORK_DIR" --target="$TARGET" --app-module="$module" \
    --cmd="$action_cmd"
  exit 0
fi

if [ "$CMD" = "port-forward" ]; then
  if [ -z "$TARGET" ] || [ -z "$PORT_MAPPING" ]; then
    echo "Usage: $0 port-forward --env=.env --target=<node> --port-mapping=<local:remote>"
    exit 1
  fi

  OLD_IFS=$IFS
  IFS=: read LOCAL_PORT REMOTE_PORT <<< "$PORT_MAPPING"
  IFS=$OLD_IFS

  $NIX_INFRA fleet port-forward -d "$WORK_DIR" --env="$WORK_DIR/.env" \
    --target="$TARGET" \
    --local-port="$LOCAL_PORT" \
    --remote-port="$REMOTE_PORT"
  exit 0
fi

# ============================================================================
# Fleet Management Commands
# ============================================================================

if [ "$CMD" = "destroy" ]; then
  if [ -z "$TARGET" ]; then
    echo "Usage: $0 destroy --env=.env --target=\"<node1> <node2> ...\""
    exit 1
  fi

  destroyNodes
  exit 0
fi

if [ "$CMD" = "update" ]; then
  if [ -z "$REST" ]; then
    echo "Usage: $0 update --env=.env <node1> <node2> ..."
    exit 1
  fi
  
  $NIX_INFRA fleet update -d "$WORK_DIR" --batch --env="$WORK_DIR/.env" \
    --nixos-version="$NIXOS_VERSION" \
    --target="$REST" \
    --node-module="node_types/standalone_machine.nix" \
    --rebuild
  
  $NIX_INFRA fleet deploy-apps -d "$WORK_DIR" --no-overlay-network --batch --env="$WORK_DIR/.env" \
    --target="$REST"
  $NIX_INFRA fleet cmd -d "$WORK_DIR" --target="$REST" "nixos-rebuild switch --fast"
  exit 0
fi

if [ "$CMD" = "upgrade" ]; then
  if [ -z "$REST" ]; then
    echo "Usage: $0 upgrade --env=.env <node1> <node2> ..."
    exit 1
  fi
  
  $NIX_INFRA fleet cmd -d "$WORK_DIR" --target="$REST" "nixos-rebuild switch --upgrade"
  exit 0
fi

if [ "$CMD" = "rollback" ]; then
  if [ -z "$REST" ]; then
    echo "Usage: $0 rollback --env=.env <node1> <node2> ..."
    exit 1
  fi

  $NIX_INFRA fleet cmd -d "$WORK_DIR" --target="$REST" "nixos-rebuild switch --rollback"
  exit 0
fi

# ============================================================================
# Create Command - Provision and Initialize Machines
# ============================================================================

if [ "$CMD" = "create" ]; then
  if [ -z "$REST" ]; then
    echo "Usage: $0 create --env=.env <node1> <node2> ..."
    exit 1
  fi

  TARGET="$REST"

  _start=$(date +%s)

  # Initialize if not already done (check for ssh directory)
  if [ ! -d "$WORK_DIR/ssh" ]; then
    echo "Initializing nix-infra..."
    $NIX_INFRA init -d "$WORK_DIR" --no-cert-auth --batch
  fi

  # Add SSH key to agent
  ssh-add "$WORK_DIR/ssh/$SSH_KEY" 2>/dev/null || true

  echo "*** Provisioning NixOS $NIXOS_VERSION ***"

  $NIX_INFRA fleet provision -d "$WORK_DIR" --batch --env="$WORK_DIR/.env" \
      --nixos-version="$NIXOS_VERSION" \
      --ssh-key="$SSH_KEY" \
      --location="$LOCATION" \
      --machine-type="$MACHINE_TYPE" \
      --node-names="$TARGET"

  cleanupOnFail $? "ERROR: Provisioning failed! Cleaning up..."

  _provision=$(date +%s)

  echo "*** Initializing machines ***"

  $NIX_INFRA fleet init-machine -d "$WORK_DIR" --batch --env="$WORK_DIR/.env" \
      --nixos-version="$NIXOS_VERSION" \
      --target="$TARGET" \
      --node-module="node_types/standalone_machine.nix"

  $NIX_INFRA fleet cmd -d "$WORK_DIR" --target="$TARGET" "nixos-rebuild switch --fast"

  _init_nodes=$(date +%s)

  echo "*** Deploying apps ***"

  $NIX_INFRA fleet deploy-apps -d "$WORK_DIR" --batch --env="$WORK_DIR/.env" \
    --target="$TARGET"
  $NIX_INFRA fleet cmd -d "$WORK_DIR" --target="$TARGET" "nixos-rebuild switch --fast"

  _end=$(date +%s)

  echo ""
  echo "=========================================="
  printf '+ provision    %s\n' "$(printTime $_start $_provision)"
  printf '+ init nodes   %s\n' "$(printTime $_provision $_init_nodes)"
  printf '+ deploy apps  %s\n' "$(printTime $_init_nodes $_end)"
  printf '= TOTAL        %s\n' "$(printTime $_start $_end)"
  echo "=========================================="
  echo "Done!"
  exit 0
fi
